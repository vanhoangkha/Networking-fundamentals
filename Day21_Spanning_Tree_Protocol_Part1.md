# 20. SPANNING TREE GIAO TH·ª®C (STP) : PART 1 REDUNDANCY trong NETWORKS - Essential trong M·∫°ng design - Modern networks l√† expected ƒë·∫øn run 24/7/265; even m·ªôt short downtime c√≥ th·ªÉ be disastrous cho business. - If one M·∫°ng component fails, you ph·∫£i ensure that other components s·∫Ω take over v·ªõi little ho·∫∑c no downtime. - As much as possible, you ph·∫£i implement REDUNDANCY t·∫°i every possible point trong the M·∫°ng AN EXAMPLE c·ªßa m·ªôt POORLY DESIGNED M·∫°ng ![image](https://github.com/psaumur/CCNA/assets/106411237/b3b76af5-11e6-495b-8c40-40eb5800704b) NOTE the many single-point failures that c√≥ th·ªÉ occur (single connections) A BETTER M·∫°ng DESIGN ![image](https://github.com/psaumur/CCNA/assets/106411237/01c20d92-2cf6-4d1f-a193-ded7753aeb38) UNFORTUNATELY : - Most PCS only have m·ªôt single M·∫°ng Giao di·ªán card (NIC), so they c√≥ th·ªÉ only be plugged into m·ªôt single Switch. However, important SERVERS typically have multiple NICs, so they c√≥ th·ªÉ be plugged into multiple SWITCHES cho redundancy! So HOW c√≥ th·ªÉ all this redundancy be m·ªôt BAD thing? Broadcast STORMS ![image](https://github.com/psaumur/CCNA/assets/106411237/a0bf91be-a463-45df-bfc5-df471d0544b5) ![image](https://github.com/psaumur/CCNA/assets/106411237/d13b6ab5-5298-4166-bdfa-3315f05a2961) ![image](https://github.com/psaumur/CCNA/assets/106411237/f719de69-df9e-4549-b3cb-914d7c5aabc4) FLOODED v·ªõi ARP REQUESTS (Red = Clockwise Loops // Purple = Counter-Clockwise Loops) M·∫°ng Congestion isn‚Äôt the only problem. Each time m·ªôt Khung arrives tr√™n m·ªôt SWITCHPORT, the Switch uses the SOURCE ƒê·ªãa ch·ªâ MAC field to ‚Äúlearn‚Äù the ƒê·ªãa ch·ªâ MAC v√† update it‚Äôs ƒê·ªãa ch·ªâ MAC TABLE. When frames v·ªõi the same SOURCE ƒê·ªãa ch·ªâ MAC repeatedly arrive tr√™n different interfaces, the Switch l√† continuously updating the Giao di·ªán trong it‚Äôs ƒê·ªãa ch·ªâ MAC TABLE. This l√† called ƒê·ªãa ch·ªâ MAC FLAPPING So how we design m·ªôt M·∫°ng, with redundant paths, that doesn‚Äôt result trong LAYER 2 LOOPS. Spanning Tree Giao th·ª©c l√† one solution --- STP (Spanning Tree Giao th·ª©c) : 802.1D - ‚ÄúClassic Spanning Tree Giao th·ª©c‚Äù is IEEE **802.1D** - SWITCHES t·ª´ ALL vendors run STP b·ªüi Default - STP prevents LAYER 2 loops b·ªüi placing redundant PORTS trong m·ªôt BLOCKING state, essentially disabling the Giao di·ªán - These INTERFACES act as backups that c√≥ th·ªÉ enter m·ªôt FORWARDING state if m·ªôt active (=currently forwarding) Giao di·ªán fails. - INTERFACES trong m·ªôt BLOCKING state only send ho·∫∑c receive STP messages (called BPDUs = Bridge Giao th·ª©c Data Units) üí° Spanning Tree Giao th·ª©c still uses the term ‚ÄúBridge‚Äù. However, when use the term ‚ÄúBridge‚Äù, we really mean ‚ÄúSwitch‚Äù. BRIDGES l√† not used trong modern networks. ![image](https://github.com/psaumur/CCNA/assets/106411237/f253770d-22fa-4e3f-91b0-8f2b4c2f1a61) ORANGE Giao di·ªán is ‚ÄúBLOCKED‚Äù causing m·ªôt break trong the loops ![image](https://github.com/psaumur/CCNA/assets/106411237/45125471-da23-4753-b5b1-16c23a2bfeff) If changes occur trong the connections, the traffic s·∫Ω adjust the C·∫•u tr√∫c m·∫°ng. - By selecting WHICH ports l√† FORWARDING v√† which ports l√† BLOCKING, STP creates m·ªôt single path TO / FROM each point trong the M·∫°ng. This prevents LAYER 2 Loops. - There l√† m·ªôt set process that STP uses ƒë·∫øn determine which ports n√™n be FORWARDING v√† which n√™n be BLOCKING - STP-enabled SWITCHES send / receive ‚ÄúHello BPDUs‚Äù out c·ªßa all INTERFACES - The Default timer is : ONCE every TWO seconds per Giao di·ªán! - If m·ªôt Switch receives a ‚ÄúHello BPDU‚Äù on m·ªôt Giao di·ªán, it knows that Giao di·ªán l√† connected ƒë·∫øn another Switch (ROUTERS, PCs, etc. do NOT use STP so do not send ‚ÄúHello BPDUs‚Äù) --- l√† g√¨ BPDUs USED FOR? - SWITCHES use one field trong the STP BPDU, the Bridge ID field, to elect m·ªôt Bridge g·ªëc cho the M·∫°ng - The Switch v·ªõi the lowest Bridge ID becomes the Bridge g·ªëc - ALL PORTS tr√™n the Bridge g·ªëc l√† put trong m·ªôt FORWARDING state, and other SWITCHES trong the C·∫•u tr√∫c m·∫°ng ph·∫£i have m·ªôt path ƒë·∫øn reach the Bridge g·ªëc ![image](https://github.com/psaumur/CCNA/assets/106411237/05177f47-882e-47ea-8bec-22e073392e1c) ![image](https://github.com/psaumur/CCNA/assets/106411237/17f921f6-0583-4070-9493-5f5d80ad4866) ![image](https://github.com/psaumur/CCNA/assets/106411237/bb49a034-9f6d-4e92-9ea0-8bc71c4f2ec8) To REDUCE the Bridge PRIORITY, we c√≥ th·ªÉ only change it trong units c·ªßa 4096 ! ![image](https://github.com/psaumur/CCNA/assets/106411237/39fe6239-1217-4885-b07b-8f368dad0e28) In THIS C·∫•u tr√∫c m·∫°ng, SW1 becomes the Bridge g·ªëc due ƒë·∫øn it‚Äôs ƒê·ªãa ch·ªâ MAC being LOWEST (Hex ‚ÄúA‚Äù = 10) ![image](https://github.com/psaumur/CCNA/assets/106411237/b1e1a69d-4b9c-46bf-9b77-f30b9f7c3933) ALL INTERFACES tr√™n the Bridge g·ªëc l√† DESIGNATED PORTS. DESIGNATED PORTS l√† trong m·ªôt FORWARDING STATE! Bridge g·ªëc - When m·ªôt Switch l√† powered on, it assumes it l√† the Bridge g·ªëc - It s·∫Ω only give up its position if it receives a ‚ÄúSUPERIOR‚Äù BPDU (lower Bridge ID) - Once the C·∫•u tr√∫c m·∫°ng has converged v√† all SWITCHES agree tr√™n the Bridge g·ªëc, only the Bridge g·ªëc sends BPDUs - Other SWITCHES trong the M·∫°ng s·∫Ω forward these BPDUs, but s·∫Ω not generate their own original BPDUs --- Spanning Tree Giao th·ª©c STEPS 1) One Switch l√† elected as Bridge g·ªëc. All PORTS tr√™n the Bridge g·ªëc l√† DESIGNATED PORTS (FORWARDING STATE) - Bridge g·ªëc selection order: - 1) Lowest Bridge ID - 2) Lowest ƒê·ªãa ch·ªâ MAC (in case c·ªßa Bridge ID tie) 2) Each remaining Switch s·∫Ω select ONE c·ªßa its INTERFACES ƒë·∫øn be it‚Äôs ROOT C·ªïng (FORWARDING STATE). PORTS across t·ª´ the ROOT C·ªïng l√† always DESIGNATED PORTS. - ROOT C·ªïng selection order: - 1) LOWEST ROOT COST (see STP COST CHART) - 2) LOWEST NEIGHBOUR Bridge ID - 3) LOWEST NEIGHBOUR C·ªïng ID 3) Each remaining COLLISION DOMAIN s·∫Ω select ONE Giao di·ªán ƒë·∫øn be m·ªôt DESIGNATION C·ªïng (FORWARDING STATE). The other C·ªïng trong the COLLISION DOMAIN s·∫Ω NON-DESIGNATED (BLOCKING) - DESIGNATED C·ªïng SELECTION: - 1) Giao di·ªán tr√™n Switch v·ªõi LOWEST ROOT COST - 2) Giao di·ªán tr√™n Switch v·ªõi LOWEST Bridge ID --- STP COST CHART üí° Only OUTGOING INTERFACES toward the Bridge g·ªëc have m·ªôt STP COST; not RECEIVING INTERFACES. Add up all the OUTGOING C·ªïng costs until you reach the Bridge g·ªëc ![image](https://github.com/psaumur/CCNA/assets/106411237/0ee95883-aed8-42a3-ba82-11209ef8cd40) SW1 l√† the Bridge g·ªëc so has m·ªôt STP COST c·ªßa 0 tr√™n ALL INTERFACES ![image](https://github.com/psaumur/CCNA/assets/106411237/35037ae9-3430-44ac-be6d-c8d2a2a42c24) The PORTS connected ƒë·∫øn another Switch‚Äôs ROOT C·ªïng ph·∫£i be DESIGNATED (D). Because the ROOT C·ªïng l√† the Switch‚Äôs path ƒë·∫øn the Bridge g·ªëc, another Switch ph·∫£i not block it. STP C·ªïng ID (in case c·ªßa m·ªôt tie-breaker) ![image](https://github.com/psaumur/CCNA/assets/106411237/63d2fb87-31fa-4b57-a2c3-a203feded8ba) NEIGHBOUR Switch C·ªïng ID (in case c·ªßa m·ªôt tie-breaker) (D) = DESIGNATED C·ªïng (R) = ROOT C·ªïng ![image](https://github.com/psaumur/CCNA/assets/106411237/c3fcc32b-e95f-4d4b-a241-f9f3080e858f) C√°ch DETERMINE WHICH C·ªïng s·∫Ω BE BLOCKED ƒë·∫øn PREVENT LAYER 2 LOOPS ![image](https://github.com/psaumur/CCNA/assets/106411237/1b69a092-4150-44c3-b605-5916fdea91d6) QUIZ Identify the Bridge g·ªëc v√† the ROLE c·ªßa EACH Giao di·ªán tr√™n the M·∫°ng (ROOT / DESIGNATED / NON-DESIGNATED) #1 ![image](https://github.com/psaumur/CCNA/assets/106411237/62bcf349-dd89-48be-92f6-d6a184edeb6f) ALL SWITCHES have the same PRIORITY NUMBER (32769) Tie-breaker goes ƒë·∫øn the LOWEST ƒê·ªãa ch·ªâ MAC SW3 has the LOWEST so it‚Äôs the Bridge g·ªëc v√† ALL it‚Äôs INTERFACES become DESIGNATED Connections t·ª´ SW1 (G0/1) and S4 (G0/0) to SW3 become ROOT INTERFACES Because SW2 has TWO connections ƒë·∫øn SW1, both c·ªßa SW1‚Äôs INCOMING interfaces become DESIGNATED. SW2 G0/2 Giao di·ªán becomes m·ªôt ROOT Giao di·ªán because the G0/0 Giao di·ªán c·ªßa SW1 l√† LOWER than it‚Äôs G0/2 Giao di·ªán The remaining interfaces tr√™n SW2 become NON-DESIGNATED because it has the HIGHEST ROOT COST (12 = 4x 1 GB connection). INTERFACES they l√† attached ƒë·∫øn tr√™n other SWITCHES become DESIGNATED #2 ![image](https://github.com/psaumur/CCNA/assets/106411237/ae382ec2-9c0f-4673-94b5-5d1411c8db6b) SW4 has the LOWEST Priority Number so it l√† designated Bridge g·ªëc All c·ªßa SW4 INTERFACES become DESIGNATED SW2 G0/0 becomes ROOT C·ªïng because SW4 G0/0 connection l√† m·ªôt LOWER NUMBER than G0/1. SW3 G0/1 becomes ROOT C·ªïng SW1 G0/1 becomes ROOT C·ªïng because G0/1 cost l√† LESS than Fa1/0 v√† 2/0 EACH remaining C·ªïng s·∫Ω be either DESIGNATED ho·∫∑c NON-DESIGNATED SW1 Fa1/0 v√† 2/0 become NON-DESIGNATED since they have m·ªôt HIGHER STP COST (38) than SW2 outbound ports (8) making SW2 Fa1/0 v√† 2/0 DESIGNATED SW2 remaining connection, G0/1, NON-DESIGNATED 