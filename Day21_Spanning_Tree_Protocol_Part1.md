# NG√ÄY 21: SPANNING TREE PROTOCOL PART1 ## 21.1 D∆Ø TH·ª™A TRONG M·∫†NG ## 21.2 # T·∫ßm quan tr·ªçng c·ªßa Redundancy: - **Thi·∫øt y·∫øu** trong thi·∫øt k·∫ø M·∫°ng - **M·∫°ng hi·ªán ƒë·∫°i** ƒë∆∞·ª£c mong ƒë·ª£i ch·∫°y 24/7/365; ngay c·∫£ th·ªùi gian ng·ª´ng ho·∫°t ƒë·ªông ng·∫Øn c≈©ng c√≥ th·ªÉ **th·∫£m kh·ªëc cho doanh nghi·ªáp** - N·∫øu m·ªôt th√†nh ph·∫ßn M·∫°ng b·ªã l·ªói, b·∫°n ph·∫£i ƒë·∫£m b·∫£o c√°c th√†nh ph·∫ßn kh√°c s·∫Ω **ti·∫øp qu·∫£n v·ªõi √≠t ho·∫∑c kh√¥ng c√≥ th·ªùi gian ng·ª´ng ho·∫°t ƒë·ªông** - C√†ng nhi·ªÅu c√†ng t·ªët, b·∫°n ph·∫£i **tri·ªÉn khai D∆Ø TH·ª™A t·∫°i m·ªçi ƒëi·ªÉm c√≥ th·ªÉ** trong M·∫°ng **ƒê·∫∑c ƒëi·ªÉm:** ## 21.3 V√ç D·ª§ V·ªÄ M·∫†NG THI·∫æT K·∫æ K√âM ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/b3b76af5 - 11e6 - 495b - 8c40 - 40eb5800704b) **Ch√∫ √Ω nhi·ªÅu ƒëi·ªÉm l·ªói ƒë∆°n c√≥ th·ªÉ x·∫£y ra (k·∫øt n·ªëi ƒë∆°n)** **ƒê·∫∑c ƒëi·ªÉm:** ## 21.4 THI·∫æT K·∫æ M·∫†NG T·ªêT H∆†N ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/01c20d92 - 2cf6 - 4d1f - a193 - ded7753aeb38) ## 21.5 # L∆∞u √Ω: - **H·∫ßu h·∫øt PC** ch·ªâ c√≥ **m·ªôt card giao di·ªán m·∫°ng (NIC)** duy nh·∫•t, v√¨ v·∫≠y ch√∫ng ch·ªâ c√≥ th·ªÉ c·∫Øm v√†o m·ªôt switch duy nh·∫•t - Tuy nhi√™n, **SERVER quan tr·ªçng** th∆∞·ªùng c√≥ **nhi·ªÅu NIC**, v√¨ v·∫≠y ch√∫ng c√≥ th·ªÉ c·∫Øm v√†o nhi·ªÅu switch ƒë·ªÉ d·ª± ph√≤ng! **ƒê·∫∑c ƒëi·ªÉm:** ## 21.6 T·∫†I SAO D∆Ø TH·ª™A C√ì TH·ªÇ L√Ä ƒêI·ªÄU X·∫§U? ## 21.7 # BROADCAST STORM ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/a0bf91be - a463 - 45df - bfc5 - df471d0544b5) ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/d13b6ab5 - 5298 - 4166 - bdfa - 3315f05a2961) ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/f719de69 - df9e - 4549 - b3cb - 914d7c5aabc4) **NG·∫¨P L·ª§T v·ªõi ARP REQUEST** (ƒê·ªè = V√≤ng l·∫∑p Thu·∫≠n chi·ªÅu kim ƒë·ªìng h·ªì // T√≠m = V√≤ng l·∫∑p Ng∆∞·ª£c chi·ªÅu kim ƒë·ªìng h·ªì) **ƒê·∫∑c ƒëi·ªÉm:** ## 21.8 V·∫§N ƒê·ªÄ MAC ADDRESS FLAPPING **T·∫Øc ngh·∫Ωn M·∫°ng kh√¥ng ph·∫£i l√† v·∫•n ƒë·ªÅ duy nh·∫•t.** M·ªói khi m·ªôt Khung ƒë·∫øn tr√™n SWITCHPORT, switch s·ª≠ d·ª•ng tr∆∞·ªùng **SOURCE MAC Address** ƒë·ªÉ "h·ªçc" ƒë·ªãa ch·ªâ MAC v√† c·∫≠p nh·∫≠t **MAC ADDRESS TABLE**. Khi c√°c khung v·ªõi c√πng **SOURCE MAC Address** li√™n t·ª•c ƒë·∫øn tr√™n c√°c interface kh√°c nhau, switch li√™n t·ª•c c·∫≠p nh·∫≠t Interface trong **MAC ADDRESS TABLE**. **ƒêi·ªÅu n√†y ƒë∆∞·ª£c g·ªçi l√† MAC ADDRESS FLAPPING** **ƒê·∫∑c ƒëi·ªÉm:** ## 21.9 GI·∫¢I PH√ÅP: SPANNING TREE PROTOCOL **L√†m th·∫ø n√†o ch√∫ng ta thi·∫øt k·∫ø m·ªôt M·∫°ng v·ªõi ƒë∆∞·ªùng d·∫´n d·ª± ph√≤ng m√† kh√¥ng d·∫´n ƒë·∫øn V√íNG L·∫∂P T·∫¶NG 2?** **Spanning Tree Protocol l√† gi·∫£i ph√°p** **ƒê·∫∑c ƒëi·ªÉm:** ## 21.10 STP (Shielded Twisted Pair) (SPANNING TREE PROTOCOL): 802.1D ## 21.11 # ƒê·∫∑c ƒëi·ªÉm c∆° b·∫£n: - **"Classic Spanning Tree Protocol"** l√† IEEE **802.1D** - **switch t·ª´ T·∫§T C·∫¢ nh√† cung c·∫•p** ch·∫°y STP (Shielded Twisted Pair) theo M·∫∑c ƒë·ªãnh - **STP (Shielded Twisted Pair) ngƒÉn ch·∫∑n V√íNG L·∫∂P T·∫¶NG 2** b·∫±ng c√°ch ƒë·∫∑t c√°c PORT d·ª± ph√≤ng trong tr·∫°ng th√°i **BLOCKING**, v·ªÅ c∆° b·∫£n v√¥ hi·ªáu h√≥a Interface - Nh·ªØng **INTERFACE n√†y ho·∫°t ƒë·ªông nh∆∞ b·∫£n sao l∆∞u** c√≥ th·ªÉ v√†o tr·∫°ng th√°i **FORWARDING** n·∫øu Interface ƒëang ho·∫°t ƒë·ªông (=hi·ªán ƒëang forwarding) b·ªã l·ªói - **INTERFACE trong tr·∫°ng th√°i BLOCKING** ch·ªâ g·ª≠i ho·∫∑c nh·∫≠n th√¥ng ƒëi·ªáp STP (Shielded Twisted Pair) (g·ªçi l√† **BPDU = Bridge Protocol Data Units**) üí° **Spanning Tree Protocol v·∫´n s·ª≠ d·ª•ng thu·∫≠t ng·ªØ "Bridge". Tuy nhi√™n, khi s·ª≠ d·ª•ng thu·∫≠t ng·ªØ "Bridge", ch√∫ng ta th·ª±c s·ª± c√≥ nghƒ©a l√† "switch". BRIDGE kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng trong m·∫°ng hi·ªán ƒë·∫°i.** ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/f253770d - 22fa - 4e3f - 91b0 - 8f2b4c2f1a61) **Interface M√ÄU CAM b·ªã "BLOCKED" g√¢y ra s·ª± gi√°n ƒëo·∫°n trong v√≤ng l·∫∑p** ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/45125471 - da23 - 4753 - b5b1 - 16c23a2bfeff) **N·∫øu c√≥ thay ƒë·ªïi trong k·∫øt n·ªëi, l∆∞u l∆∞·ª£ng s·∫Ω ƒëi·ªÅu ch·ªânh C·∫•u tr√∫c m·∫°ng.** **ƒê·∫∑c ƒëi·ªÉm:** ## 21.12 C√ÅCH HO·∫†T ƒê·ªòNG C·ª¶A STP (Shielded Twisted Pair) ## 21.13 # Nguy√™n t·∫Øc c∆° b·∫£n: - B·∫±ng c√°ch ch·ªçn port n√†o **FORWARDING** v√† port n√†o **BLOCKING**, STP (Shielded Twisted Pair) t·∫°o ra **m·ªôt ƒë∆∞·ªùng d·∫´n duy nh·∫•t ƒê·∫æN/T·ª™ m·ªói ƒëi·ªÉm** trong M·∫°ng - ƒêi·ªÅu n√†y **ngƒÉn ch·∫∑n V√íNG L·∫∂P T·∫¶NG 2** - C√≥ m·ªôt **quy tr√¨nh c·ªë ƒë·ªãnh** m√† STP (Shielded Twisted Pair) s·ª≠ d·ª•ng ƒë·ªÉ x√°c ƒë·ªãnh port n√†o n√™n **FORWARDING** v√† port n√†o n√™n **BLOCKING** ## 21.14 # Hello BPDU: - **switch h·ªó tr·ª£ STP (Shielded Twisted Pair)** g·ª≠i/nh·∫≠n **"Hello BPDU"** ra kh·ªèi t·∫•t c·∫£ INTERFACE - **Timer m·∫∑c ƒë·ªãnh:** **M·ªñI HAI GI√ÇY m·ªôt l·∫ßn** tr√™n m·ªói Interface! - N·∫øu switch nh·∫≠n **"Hello BPDU"** tr√™n Interface, n√≥ bi·∫øt Interface ƒë√≥ ƒë∆∞·ª£c k·∫øt n·ªëi v·ªõi switch kh√°c (**router, PC, v.v. KH√îNG s·ª≠ d·ª•ng STP (Shielded Twisted Pair)** n√™n kh√¥ng g·ª≠i "Hello BPDU") **ƒê·∫∑c ƒëi·ªÉm:** ## 21.15 BPDU ƒê∆Ø·ª¢C S·ª¨ D·ª§NG ƒê·ªÇ L√ÄM G√å? ## 21.16 # B·∫ßu ch·ªçn Root Bridge: - **switch s·ª≠ d·ª•ng m·ªôt tr∆∞·ªùng** trong STP (Shielded Twisted Pair) BPDU, **tr∆∞·ªùng Bridge ID**, ƒë·ªÉ b·∫ßu ch·ªçn **Root Bridge** cho M·∫°ng - **switch c√≥ Bridge ID th·∫•p nh·∫•t** tr·ªü th√†nh **Root Bridge** - **T·∫§T C·∫¢ PORT tr√™n Root Bridge** ƒë∆∞·ª£c ƒë·∫∑t trong tr·∫°ng th√°i **FORWARDING**, v√† c√°c switch kh√°c trong C·∫•u tr√∫c m·∫°ng ph·∫£i c√≥ ƒë∆∞·ªùng d·∫´n ƒë·ªÉ ƒë·∫øn **Root Bridge** ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/05177f47 - 882e - 47ea - 8bec - 22e073392e1c) ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/17f921f6 - 0583 - 4070 - 9493 - 5f5d80ad4866) ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/bb49a034 - 9f6d - 4e92 - 9ea0 - 8bc71c4f2ec8) **ƒê·ªÉ GI·∫¢M Bridge PRIORITY, ch√∫ng ta ch·ªâ c√≥ th·ªÉ thay ƒë·ªïi n√≥ theo ƒë∆°n v·ªã 4096!** ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/39fe6239 - 1217 - 4885 - b07b - 8f368dad0e28) **Trong C·∫•u tr√∫c m·∫°ng N√ÄY, SW1 tr·ªü th√†nh Root Bridge do ƒë·ªãa ch·ªâ MAC c·ªßa n√≥ TH·∫§P NH·∫§T (Hex "A" = 10)** ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/b1e1a69d - 4b9c - 46bf - 9b77 - f30b9f7c3933) **ƒê·∫∑c ƒëi·ªÉm:** ## 21.17 DESIGNATED PORT **T·∫§T C·∫¢ INTERFACE tr√™n Root Bridge l√† DESIGNATED PORT. DESIGNATED PORT ·ªü tr·∫°ng th√°i FORWARDING!** ## 21.18 # Qu√° tr√¨nh b·∫ßu ch·ªçn Root Bridge: - Khi switch ƒë∆∞·ª£c b·∫≠t, n√≥ **gi·∫£ ƒë·ªãnh m√¨nh l√† Root Bridge** - N√≥ s·∫Ω ch·ªâ **t·ª´ b·ªè v·ªã tr√≠** n·∫øu nh·∫≠n ƒë∆∞·ª£c **"SUPERIOR" BPDU** (Bridge ID th·∫•p h∆°n) - Khi C·∫•u tr√∫c m·∫°ng ƒë√£ **h·ªôi t·ª•** v√† t·∫•t c·∫£ switch ƒë·ªìng √Ω v·ªÅ Root Bridge, **ch·ªâ Root Bridge g·ª≠i BPDU** - C√°c switch kh√°c trong M·∫°ng s·∫Ω **chuy·ªÉn ti·∫øp nh·ªØng BPDU n√†y**, nh∆∞ng s·∫Ω **kh√¥ng t·∫°o BPDU g·ªëc ri√™ng** **ƒê·∫∑c ƒëi·ªÉm:** ## 21.19 C√ÅC B∆Ø·ªöC C·ª¶A SPANNING TREE PROTOCOL ## 21.20 # B∆∞·ªõc 1: B·∫ßu ch·ªçn Root Bridge **M·ªôt switch ƒë∆∞·ª£c b·∫ßu l√†m Root Bridge. T·∫§T C·∫¢ PORT tr√™n Root Bridge l√† DESIGNATED PORT (TR·∫†NG TH√ÅI FORWARDING)** **Th·ª© t·ª± ch·ªçn Root Bridge:** 1. **Bridge ID th·∫•p nh·∫•t** 2. **ƒê·ªãa ch·ªâ MAC th·∫•p nh·∫•t** (khi Bridge ID b·∫±ng nhau) ## 21.21 # B∆∞·ªõc 2: Ch·ªçn Root Port **M·ªói switch c√≤n l·∫°i s·∫Ω ch·ªçn M·ªòT trong c√°c INTERFACE c·ªßa n√≥ l√†m ROOT PORT (TR·∫†NG TH√ÅI FORWARDING). PORT ƒë·ªëi di·ªán v·ªõi ROOT PORT lu√¥n l√† DESIGNATED PORT.** **Th·ª© t·ª± ch·ªçn Root Port:** 1. **ROOT COST TH·∫§P NH·∫§T** (xem B·∫¢NG STP (Shielded Twisted Pair) COST) 2. **NEIGHBOR Bridge ID TH·∫§P NH·∫§T** 3. **NEIGHBOR Port ID TH·∫§P NH·∫§T** ## 21.22 # B∆∞·ªõc 3: Ch·ªçn Designated Port **M·ªói COLLISION DOMAIN c√≤n l·∫°i s·∫Ω ch·ªçn M·ªòT Interface l√†m DESIGNATED PORT (TR·∫†NG TH√ÅI FORWARDING). Port kh√°c trong COLLISION DOMAIN s·∫Ω l√† NON - DESIGNATED (BLOCKING)** **Ch·ªçn DESIGNATED Port:** 1. **Interface tr√™n switch c√≥ ROOT COST TH·∫§P NH·∫§T** 2. **Interface tr√™n switch c√≥ Bridge ID TH·∫§P NH·∫§T** **ƒê·∫∑c ƒëi·ªÉm:** ## 21.23 B·∫¢NG STP (Shielded Twisted Pair) COST üí° **Ch·ªâ c√≥ INTERFACE RA NGO√ÄI h∆∞·ªõng v·ªÅ Root Bridge m·ªõi c√≥ STP (Shielded Twisted Pair) COST; kh√¥ng ph·∫£i INTERFACE NH·∫¨N V√ÄO. C·ªông t·∫•t c·∫£ chi ph√≠ Port RA NGO√ÄI cho ƒë·∫øn khi b·∫°n ƒë·∫øn Root Bridge** ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/0ee95883 - aed8 - 42a3 - ba82 - 11209ef8cd40) | T·ªëc ƒë·ªô Link | STP (Shielded Twisted Pair) Cost | | - - - - - - - - - - - - - | - - - - - - - - - - | | 10 Mbps | 100 | | 100 Mbps | 19 | | 1 Gbps | 4 | | 10 Gbps | 2 | **SW1 l√† Root Bridge n√™n c√≥ STP (Shielded Twisted Pair) COST l√† 0 tr√™n T·∫§T C·∫¢ INTERFACE** ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/35037ae9 - 3430 - 44ac - be6d - c8d2a2a42c24) **PORT k·∫øt n·ªëi v·ªõi ROOT PORT c·ªßa switch kh√°c ph·∫£i l√† DESIGNATED (D). V√¨ ROOT PORT l√† ƒë∆∞·ªùng d·∫´n c·ªßa switch ƒë·∫øn Root Bridge, switch kh√°c kh√¥ng ƒë∆∞·ª£c ch·∫∑n n√≥.** **ƒê·∫∑c ƒëi·ªÉm:** ## 21.24 STP (Shielded Twisted Pair) PORT ID ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/63d2fb87 - 31fa - 4b57 - a2c3 - a203feded8ba) **NEIGHBOR switch Port ID (khi tie - breaker)** **(D) = DESIGNATED Port** **(R) = ROOT Port** ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/c3fcc32b - e95f - 4d4b - a241 - f9f3080e858f) **ƒê·∫∑c ƒëi·ªÉm:** ## 21.25 X√ÅC ƒê·ªäNH PORT N√ÄO S·∫º B·ªä CH·∫∂N ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/1b69a092 - 4150 - 44c3 - b605 - 5916fdea91d6) **ƒê·∫∑c ƒëi·ªÉm:** ## 21.26 B√ÄI T·∫¨P TH·ª∞C H√ÄNH ## 21.27 # X√°c ƒë·ªãnh Root Bridge v√† VAI TR√í c·ªßa M·ªñI Interface tr√™n M·∫°ng (ROOT / DESIGNATED / NON - DESIGNATED) ## 21.28 # B√†i t·∫≠p #1: ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/62bcf349 - dd89 - 48be - 92f6 - d6a184edeb6f) **Gi·∫£i:** - **T·∫§T C·∫¢ switch c√≥ c√πng PRIORITY NUMBER (32769)** - **Tie - breaker** ƒë·∫øn **ƒë·ªãa ch·ªâ MAC TH·∫§P NH·∫§T** - **SW3 c√≥ TH·∫§P NH·∫§T** n√™n l√† Root Bridge v√† **T·∫§T C·∫¢ INTERFACE c·ªßa n√≥ tr·ªü th√†nh DESIGNATED** - K·∫øt n·ªëi t·ª´ SW1 (G0/1) v√† SW4 (G0/0) ƒë·∫øn SW3 tr·ªü th√†nh **ROOT INTERFACE** - V√¨ SW2 c√≥ **HAI k·∫øt n·ªëi** ƒë·∫øn SW1, c·∫£ hai interface INCOMING c·ªßa SW1 tr·ªü th√†nh **DESIGNATED** - SW2 G0/2 Interface tr·ªü th√†nh **ROOT Interface** v√¨ G0/0 Interface c·ªßa SW1 **TH·∫§P H∆†N** G0/2 Interface c·ªßa n√≥ - C√°c interface c√≤n l·∫°i tr√™n SW2 tr·ªü th√†nh **NON - DESIGNATED** v√¨ n√≥ c√≥ **ROOT COST CAO NH·∫§T** (12 = 4 √ó k·∫øt n·ªëi 1 GB) ## 21.29 # B√†i t·∫≠p #2: ![image](HTTPS: //github.com/psaumur/CCNA/assets/106411237/ae382ec2 - 9c0f - 4673 - 94b5 - 5d1411c8db6b) **Gi·∫£i:** - **SW4 c√≥ Priority Number TH·∫§P NH·∫§T** n√™n ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh l√†m Root Bridge - **T·∫•t c·∫£ INTERFACE c·ªßa SW4** tr·ªü th√†nh **DESIGNATED** - **SW2 G0/0** tr·ªü th√†nh **ROOT Port** v√¨ k·∫øt n·ªëi SW4 G0/0 c√≥ **S·ªê TH·∫§P H∆†N** G0/1 - **SW3 G0/1** tr·ªü th√†nh **ROOT Port** - **SW1 G0/1** tr·ªü th√†nh **ROOT Port** v√¨ chi ph√≠ G0/1 **√çT H∆†N** Fa1/0 v√† 2/0 - **M·ªói Port c√≤n l·∫°i** s·∫Ω l√† **DESIGNATED** ho·∫∑c **NON - DESIGNATED** - **SW1 Fa1/0 v√† 2/0** tr·ªü th√†nh **NON - DESIGNATED** v√¨ ch√∫ng c√≥ **STP (Shielded Twisted Pair) COST CAO H∆†N** (38) so v·ªõi port outbound c·ªßa SW2 (8) l√†m cho **SW2 Fa1/0 v√† 2/0** l√† **DESIGNATED** - **K·∫øt n·ªëi c√≤n l·∫°i c·ªßa SW2, G0/1**, l√† **NON - DESIGNATED**