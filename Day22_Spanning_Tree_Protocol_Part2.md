# 21. SPANNING TREE GIAO TH·ª®C (STP) : PART 2 STP STATES ![image](https://github.com/psaumur/CCNA/assets/106411237/5c9a17ff-b0d6-455c-8677-5144dd5a0048) - ROOT / DESIGNATED PORTS remain STABLE trong m·ªôt FORWARDING state - NON-DESIGNATED PORTS remain STABLE trong m·ªôt BLOCKING state - LISTENING v√† LEARNING l√† TRANSITIONAL states which l√† passed through when m·ªôt Giao di·ªán l√† activated, or when m·ªôt BLOCKING C·ªïng ph·∫£i transition ƒë·∫øn m·ªôt FORWARDING state due ƒë·∫øn m·ªôt change trong M·∫°ng C·∫•u tr√∫c m·∫°ng. **1) BLOCKING / STABLE** - NON-DESIGNATED PORTS l√† trong m·ªôt BLOCKING state - Interfaces trong m·ªôt BLOCKING state l√† effectively disabled ƒë·∫øn prevent loops - Interfaces trong m·ªôt BLOCKING state do NOT Send/Receive regular M·∫°ng traffic - Interfaces trong m·ªôt BLOCKING state do NOT forward STP BPDUs - Interfaces trong m·ªôt BLOCKING state do NOT learn MAC ADDRESSES **2) LISTENING / TRANSITIONAL** - After the BLOCKING state, interfaces v·ªõi the DESIGNATED ho·∫∑c ROOT role enter the LISTENING state - ONLY DESIGNATED ho·∫∑c ROOT PORTS enter the LISTENING state (NON-DESIGNATED PORTS l√† ALWAYS BLOCKING) - The LISTENING state l√† 15 seconds long b·ªüi Default. This l√† determined b·ªüi the FORWARD DELAY TIMER - Interfaces trong m·ªôt LISTENING state do NOT Send / Receive regular M·∫°ng traffic - Interfaces trong m·ªôt LISTENING state ONLY Forward/Receive STP BPDUs - Interfaces trong m·ªôt LISTENING state does NOT learn MAC ADDRESSES t·ª´ regular traffic that arrives tr√™n the Giao di·ªán **3) LEARNING / TRANSITIONAL** - After the LISTENING state, a DESIGNATED ho·∫∑c ROOT C·ªïng s·∫Ω enter the LEARNING state - The LEARNING state l√† 15 seconds long b·ªüi Default. This l√† determined b·ªüi the FORWARD DELAY TIMER (same one used cho both LISTENING v√† LEARNING states) - Interfaces trong m·ªôt LEARNING state do NOT Send / Receive regular M·∫°ng traffic - Interfaces trong m·ªôt LEARNING state ONLY Sends/Receives STP BPDUs - Interfaces trong m·ªôt LEARNING state **learns** MAC ADDRESSES t·ª´ regular traffic that arrives tr√™n the Giao di·ªán 4) FORWARDING / STABLE - ROOT v√† DESIGNATED PORTS l√† trong m·ªôt FORWARDING state - A C·ªïng trong the FORWARDING state operate as NORMAL - A C·ªïng trong the FORWARDING state Sends/Receives regular M·∫°ng traffic - A C·ªïng trong the FORWARDING state Sends/Receives STP BPDUs - A C·ªïng trong the FORWARDING state **learns** MAC ADDRESSES SUMMARY : ![image](https://github.com/psaumur/CCNA/assets/106411237/f4cea5ca-b90a-423e-9160-f206b8b1621d) --- STP TIMERS ![image](https://github.com/psaumur/CCNA/assets/106411237/a174469f-9e75-4645-aff8-d4bfe46fb207) üí° SWITCHES do NOT forward the BPDUs out c·ªßa their ROOT PORTS v√† NON-DESIGNATED PORTS - ONLY their DESIGNATED PORTS !!! MAX AGE TIMER: - If another BPDU l√† received BEFORE MAX AGE TIMER counts down ƒë·∫øn 0, the TIME s·∫Ω RESET ƒë·∫øn 20 Seconds v√† no changes s·∫Ω occur. - If another BPDU l√† not received, the MAX AGE TIMER counts down ƒë·∫øn 0 v√† the Switch s·∫Ω re-evaluate it‚Äôs STP choices, including Bridge g·ªëc, LOCAL ROOT, DESIGNATED, and NON-DESIGNATED PORTS. - If m·ªôt NON-DESIGNATED C·ªïng l√† selected ƒë·∫øn become m·ªôt DESIGNATED ho·∫∑c ROOT C·ªïng, it s·∫Ω transition t·ª´ the BLOCKING state ƒë·∫øn the LISTENING state (15 Seconds), LEARNING state (15 Seconds), and then finally the FORWARDING state. - So‚Ä¶ it c√≥ th·ªÉ take 50 Seconds cho m·ªôt BLOCKING Giao di·ªán ƒë·∫øn transition ƒë·∫øn FORWARDING! (MAX AGE TIMER + (LISTENING + LEARNING 15 Second timers)) - These TIMERS v√† TRANSITIONAL STATES l√† ƒë·∫øn make sure that LOOPS l√† not accidentally created b·ªüi m·ªôt Giao di·ªán moving ƒë·∫øn FORWARDING STATE too soon HOWEVER ‚Ä¶ üí° A FORWARDING Giao di·ªán c√≥ th·ªÉ move DIRECTLY ƒë·∫øn m·ªôt BLOCKING state (there l√† no worry about creating m·ªôt loop) üí° A BLOCKING Giao di·ªán c√≥ th·ªÉ NOT move DIRECTLY ƒë·∫øn m·ªôt FORWARDING state. It ph·∫£i go through the LISTENING v√† LEARNING states first! --- STP BPDU (Bridge Giao th·ª©c DATA UNIT) Ethernet Header c·ªßa m·ªôt BPDU ![image](https://github.com/psaumur/CCNA/assets/106411237/0e68839f-c4ec-448b-8876-791212462009) üí° PVST+ uses the ƒê·ªãa ch·ªâ MAC : 01 : 00 : 0c : cc : cc : cd PVST = ONLY ISL Trunk ƒê√≥ng g√≥i PVST+ = Supports 802.1Q üí° Regular STP (not Cisco‚Äôs PVST+) uses the ƒê·ªãa ch·ªâ MAC : 01 : 80 : c2 : 00 : 00 : 00 üí° The STP TIMERS tr√™n the Bridge g·ªëc determine ALL STP TIMERS cho the entire M·∫°ng! --- STP OPTIONAL FEATURES (STP TOOLKIT) PORTFAST: - Can be Enabled tr√™n INTERFACES which l√† connected ƒë·∫øn END HOSTS üí° PORTFAST allows m·ªôt C·ªïng ƒë·∫øn move immediately ƒë·∫øn the FORWARDING state, bypassing LISTENING v√† LEARNING - If used, it ph·∫£i be ENABLED only tr√™n PORTS connected ƒë·∫øn END HOSTS - If ENABLED tr√™n m·ªôt C·ªïng connected ƒë·∫øn another Switch, it c√≥ th·ªÉ cause m·ªôt LAYER 2 LOOP ![image](https://github.com/psaumur/CCNA/assets/106411237/43c91f09-0d9f-4b81-b5a2-f02003e25b88) You c√≥ th·ªÉ also K√≠ch ho·∫°t PORTFAST v·ªõi the following L·ªánh: üí° SW1(config)# spanning-tree portfast Default This ENABLES PORTFAST tr√™n ALL Truy c·∫≠p PORTS (not Trunk PORTS) BPDU GUARD: - If m·ªôt Giao di·ªán v·ªõi BPDU GUARD ENABLED receives m·ªôt BPDU t·ª´ another Switch, the Giao di·ªán s·∫Ω be SHUT DOWN ƒë·∫øn prevent loops t·ª´ forming. ![image](https://github.com/psaumur/CCNA/assets/106411237/00c61767-72b4-4d51-b964-f76b6f4f6ae9) You c√≥ th·ªÉ also K√≠ch ho·∫°t BPDU GUARD v·ªõi the following L·ªánh: üí° SW1(config)# spanning-tree portfast bpduguard Default This ENABLES BPDU GUARD tr√™n all PORTFAST-enabled INTERFACES ROOT GUARD / LOOP GUARD: ![image](https://github.com/psaumur/CCNA/assets/106411237/bb38aedc-df38-4d76-b6cb-30319e74ecc1) You probably do NOT have ƒë·∫øn know these STP optional features (or others such as UplinkFast, Backbone Fast, etcetera) for the CCNA. BUT‚Ä¶ üí° Make sure you know PORTFAST v√† BPDU GUARD. --- STP C·∫•u h√¨nh L·ªánh ƒë·∫øn CONFIGURE Spanning-Tree mode tr√™n m·ªôt Switch ![image](https://github.com/psaumur/CCNA/assets/106411237/f29e2f41-3fac-463c-ab14-bb2d2f49816d) Modern Cisco SWITCHES run **rapid-PVST**, by Default --- CONFIGURE THE PRIMARY Bridge g·ªëc L·ªánh ƒë·∫øn CONFIGURE Spanning-Tree PRIMARY Bridge g·ªëc tr√™n m·ªôt Switch ![image](https://github.com/psaumur/CCNA/assets/106411237/e90f16ad-c85c-4868-bbf4-9095c0abd581) Confirm with ‚Äú(do) show spanning-tree‚Äù Can see trong the above example, SW3 has become the ‚Äúroot‚Äù - The ‚Äúspanning-tree VLAN <VLAN-number> root primary‚Äù L·ªánh sets the STP PRIORITY ƒë·∫øn 24576. If another Switch already has m·ªôt priority number lower than 24576, it sets this Switch‚Äôs priority ƒë·∫øn 4096 LESS THAN the other Switch‚Äôs Priority (remember STP PART 1 lecture) --- SECONDARY ROOT BRIGE (backup Bridge g·ªëc) L·ªánh ƒë·∫øn CONFIGURE Spanning-Tree SECONDARY Bridge g·ªëc tr√™n m·ªôt Switch ![image](https://github.com/psaumur/CCNA/assets/106411237/7d28f782-4673-4bc8-9aae-999aeac90685) - The ‚Äúspanning-tree VLAN <VLAN-number> root secondary‚Äù L·ªánh sets the STP PRIORITY ƒë·∫øn 28672 (exactly 4096 higher than 24576). --- VLAN 1 C·∫•u tr√∫c m·∫°ng running PVST+ ![image](https://github.com/psaumur/CCNA/assets/106411237/880a4cc7-e472-4764-a68b-a62288066796) SW1 WAS the PRIMARY Bridge g·ªëc but : - We have configured SW3 ƒë·∫øn be the PRIMARY - We have configured SW2 ƒë·∫øn be the SECONDARY The C·∫•u tr√∫c m·∫°ng cho VLAN 2, however, won‚Äôt be the same. It s·∫Ω be the OLD C·∫•u tr√∫c m·∫°ng. ![image](https://github.com/psaumur/CCNA/assets/106411237/2cedeb36-27f1-4984-96e7-28ab70957c51) WHY? Because we made changes ONLY ƒë·∫øn the C·∫•u tr√∫c m·∫°ng found trong VLAN 1 (see the commands we used) --- CONFIGURE STP C·ªïng SETTINGS ![image](https://github.com/psaumur/CCNA/assets/106411237/58af0a8d-eeb4-4c34-8b54-6b8ff511695c) ‚Äúcost‚Äù = ‚ÄúROOT COST‚Äù ‚ÄúC·ªïng-priority‚Äù = ‚ÄúC·ªïng PRIORITY‚Äù 